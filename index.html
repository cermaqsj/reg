<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Registro Planta | Cermaq</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css?v=5">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="Q.png">
    <meta name="theme-color" content="#60a5fa">
</head>

<body>

    <!-- Minimal Premium Header -->
    <header class="app-header fade-in-down d-flex justify-content-between align-items-center px-3">
        <div class="d-flex flex-column align-items-center mx-auto">
            <img src="Cermaq_logo2.png" alt="Cermaq Logo" class="nav-logo">
            <p class="header-subtitle mb-0">CONTROL O2 Y ENERGÍA</p>
        </div>
        <a href="monitor.html"
            class="btn btn-outline-light btn-sm rounded-circle d-flex align-items-center justify-content-center border-opacity-25"
            style="width: 40px; height: 40px; position: absolute; right: 15px;" title="Ir al Monitor">
            <i class="bi bi-activity" style="font-size: 1.2rem;"></i>
        </a>
    </header>

    <!-- Status Dashboard -->
    <div class="status-dashboard fade-in-down" style="animation-delay: 0.1s;">
        <div class="status-row">
            <div class="status-item">
                <i class="bi bi-cloud-check" id="sheetsIcon"></i>
                <span class="status-label">Sheets</span>
                <span class="status-value" id="sheetsStatus">Verificando...</span>
            </div>
            <div class="status-item interactive" onclick="showLastSubmissionDetails()"
                title="Ver detalles del último envío">
                <i class="bi bi-clock-history"></i>
                <span class="status-label">Último Envío</span>
                <span class="status-value" id="lastSubmit">Cargando...</span>
            </div>
        </div>
    </div>

    <form id="registroForm" novalidate onsubmit="handleSubmit(event)">

        <!-- Card: Identificación -->
        <div class="card glass-card mb-4 fade-in-up" style="animation-delay: 0.1s">
            <div class="card-header-custom">
                <i class="bi bi-person-badge-fill me-2"></i>Identificación
            </div>
            <div class="card-body">
                <div class="form-floating mb-1">
                    <input type="text" class="form-control custom-input" id="responsable" placeholder="Nombre Apellido"
                        required>
                    <label for="responsable">Responsable del Turno (Nombre)</label>
                </div>
            </div>
        </div>

        <!-- Card: Oxígeno -->
        <div class="card glass-card mb-4 fade-in-up" style="animation-delay: 0.2s">
            <div class="card-header-custom">
                <i class="bi bi-wind me-2"></i>Sistema de Oxígeno
            </div>
            <div class="card-body">
                <h6 class="section-subtitle">Compresor</h6>
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="form-floating">
                            <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                id="o2_comp_kw" placeholder="KW">
                            <label>KW</label>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-floating">
                            <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                id="o2_comp_m3" placeholder="m3">
                            <label>m³</label>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-floating">
                            <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                id="o2_comp_hrs" placeholder="Hrs">
                            <label>Hrs</label>
                        </div>
                    </div>
                </div>

                <h6 class="section-subtitle">Generadores O₂</h6>
                <!-- Displayed separately as requested -->
                <div class="generator-block">
                    <h6 class="gen-title">Generador 1</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="o2_gen1_hrs" placeholder="Horas">
                                <label>Horas</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="o2_gen1_m3" placeholder="m3">
                                <label>m³</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="generator-block">
                    <h6 class="gen-title">Generador 2</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="o2_gen2_hrs" placeholder="Horas">
                                <label>Horas</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="o2_gen2_m3" placeholder="m3">
                                <label>m³</label>
                            </div>
                        </div>
                    </div>
                </div>

                <h6 class="section-subtitle">Consumo O₂</h6>
                <div class="row g-2">
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                id="o2_cons_fry" placeholder="Fry">
                            <label>Fry</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                id="o2_cons_smolt" placeholder="Smolt">
                            <label>Smolt</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card: Energía -->
        <div class="card glass-card mb-4 fade-in-up" style="animation-delay: 0.3s">
            <div class="card-header-custom">
                <i class="bi bi-lightning-charge-fill me-2"></i>Energía (Red EMpro)
            </div>
            <div class="card-body">

                <h6 class="section-subtitle">Voltaje (V)</h6>
                <div class="row g-2 mb-3">
                    <div class="col-4"><input type="number" inputmode="numeric" step="1"
                            class="form-control custom-input text-center" id="red_v12" placeholder="V12"></div>
                    <div class="col-4"><input type="number" inputmode="numeric" step="1"
                            class="form-control custom-input text-center" id="red_v23" placeholder="V23"></div>
                    <div class="col-4"><input type="number" inputmode="numeric" step="1"
                            class="form-control custom-input text-center" id="red_v31" placeholder="V31"></div>
                </div>

                <h6 class="section-subtitle">Corriente (A)</h6>
                <div class="row g-2 mb-3">
                    <div class="col-4"><input type="number" inputmode="numeric" step="1"
                            class="form-control custom-input text-center px-1" id="red_i1" placeholder="I1"></div>
                    <div class="col-4"><input type="number" inputmode="numeric" step="1"
                            class="form-control custom-input text-center px-1" id="red_i2" placeholder="I2"></div>
                    <div class="col-4"><input type="number" inputmode="numeric" step="1"
                            class="form-control custom-input text-center px-1" id="red_i3" placeholder="I3"></div>
                    <!-- Removed Red_IN (IN) as requested, removed from layout but backend logic needs handling -->
                </div>

                <h6 class="section-subtitle">Potencia Total</h6>
                <div class="row g-2">
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                id="red_sump_kw" placeholder="KW">
                            <label>Sum P (KW)</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                id="red_ea_gw" placeholder="GW">
                            <label>EA+ (GW)</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card: Generadores Diesel -->
        <div class="card glass-card mb-4 fade-in-up" style="animation-delay: 0.4s">
            <div class="card-header-custom">
                <i class="bi bi-fuel-pump-diesel-fill me-2"></i>Generadores Diesel
            </div>
            <div class="card-body">
                <!-- Gen 1 -->
                <div class="generator-block">
                    <h6 class="gen-title">Generador 1</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="d_gen1_hrs" placeholder="Hrs">
                                <label>Hrs</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="d_gen1_kw" placeholder="KW">
                                <label>KW</label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Gen 2 -->
                <div class="generator-block">
                    <h6 class="gen-title">Generador 2</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="d_gen2_hrs" placeholder="Hrs">
                                <label>Hrs</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="d_gen2_kw" placeholder="KW">
                                <label>KW</label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Gen 3 -->
                <div class="generator-block">
                    <h6 class="gen-title">Generador 3</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="d_gen3_hrs" placeholder="Hrs">
                                <label>Hrs</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="number" inputmode="numeric" step="1" class="form-control custom-input"
                                    id="d_gen3_kw" placeholder="KW">
                                <label>KW</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="d-grid mb-5">
            <button type="submit" class="btn btn-primary btn-lg custom-btn">Confirmar y Enviar</button>
        </div>

    </form>


    <!-- Admin Trigger & App Controls -->
    <div class="bottom-actions">
        <div class="action-icons">
            <i class="bi bi-gear-fill admin-trigger" onclick="toggleAdmin()" title="Modo Admin"></i>
            <i class="bi bi-key-fill admin-trigger" onclick="openChangePinModal()" title="Cambiar PIN"
                style="color: #f59e0b;"></i>
        </div>
        <div class="app-controls">
            <span class="version-badge" id="appVersion">v6.0.0</span>
            <button class="btn-update-compact" id="btnForceUpdate" title="Limpiar cache y actualizar a última versión">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>

    <!-- PWA Install Button -->
    <div id="installContainer" class="text-center pb-5" style="display: none;">
        <button id="installButton" class="btn btn-lg btn-install-pwa">
            <img src="Q.png" alt="App Icon" style="width: 32px; height: 32px; margin-right: 10px;">
            Instalar APP
        </button>
    </div>

    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-modal">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Registros</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalSummary">
                    <!-- Summary injected by JS -->
                </div>
                <div class="modal-footer border-top pt-3" style="display: block;">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-shield-lock-fill"></i> <strong>Validación Requerida</strong>
                        <p class="small mb-0 mt-1">Ingrese su nombre y PIN de autorización para confirmar el envío.</p>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="confirmResponsable" placeholder="Responsable"
                            required>
                        <label>Responsable del Turno</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="authPin" placeholder="PIN" maxlength="4"
                            inputmode="numeric" required autocomplete="off">
                        <label><i class="bi bi-key-fill"></i> PIN de Autorización (4 dígitos)</label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button type="button" class="btn btn-success flex-fill" id="btnFinalSend" onclick="sendData()">
                            <i class="bi bi-check-circle"></i> Enviar Definitivo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Cambiar PIN -->
    <div class="modal fade" id="changePinModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-modal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock"></i> Cambiar PIN de Autorización
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Acceso Restringido</strong>
                        <p class="small mb-0 mt-1">Requiere contraseña de administrador para cambiar el PIN.</p>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="adminPassForPin" placeholder="Password Admin"
                            required autocomplete="off">
                        <label>Contraseña de Administrador</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="currentPinInput" placeholder="PIN Actual"
                            maxlength="4" inputmode="numeric" required autocomplete="off">
                        <label>PIN Actual (4 dígitos)</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="newPinInput" placeholder="Nuevo PIN"
                            maxlength="4" inputmode="numeric" required autocomplete="off">
                        <label>Nuevo PIN (4 dígitos)</label>
                    </div>

                    <div class="form-floating">
                        <input type="password" class="form-control" id="confirmNewPinInput" placeholder="Confirmar PIN"
                            maxlength="4" inputmode="numeric" required autocomplete="off">
                        <label>Confirmar Nuevo PIN</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="submitPinChange()">
                        <i class="bi bi-check-circle"></i> Cambiar PIN
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content glass-modal">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary">
                        <i class="bi bi-clock-history me-2"></i>Último Registro
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-2">
                    <div class="text-center mb-3">
                        <div class="badge bg-primary bg-opacity-10 text-primary p-2 rounded-3 mb-2">
                            <i class="bi bi-calendar-event me-1"></i> <span id="histTimestamp" class="fw-bold">--</span>
                        </div>
                        <h6 class="text-muted small text-uppercase ls-1">Responsable</h6>
                        <p id="histResponsable" class="fw-bold fs-5 mb-0 text-dark">--</p>
                    </div>
                    <hr class="opacity-10">
                    <div id="histContent" class="d-flex flex-column gap-2">
                        <!-- Content injected via JS -->
                        <div class="text-center text-muted py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <p class="small mt-2">Cargando detalles...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-outline-secondary w-100 rounded-pill"
                        data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js?v=5"></script>

    <script>
        // Security: Clear PIN when modal is closed/cancelled
        const confirmModalElement = document.getElementById('confirmModal');
        confirmModalElement.addEventListener('hidden.bs.modal', function () {
            document.getElementById('authPin').value = '';
        });

        // Mobile: Prevent accidental navigation/close
        let formHasData = false;
        document.getElementById('registroForm').addEventListener('input', () => {
            formHasData = true;
        });

        // Warn before leaving page with unsaved data
        window.addEventListener('beforeunload', (e) => {
            if (formHasData) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // Handle back button on mobile
        window.addEventListener('popstate', (e) => {
            if (formHasData) {
                if (!confirm('¿Seguro que quieres salir? Los datos no guardados se perderán.')) {
                    window.history.pushState(null, '', window.location.href);
                }
            }
        });

        // Push initial state for back button handling
        window.history.pushState(null, '', window.location.href);
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js');
        }

        // PWA Install Button Logic
        let deferredPrompt;
        const installContainer = document.getElementById('installContainer');
        const installButton = document.getElementById('installButton');

        // Show button if app is not installed
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installContainer.style.display = 'block';
        });

        // Handle install button click
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) return;

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                installContainer.style.display = 'none';
            }

            deferredPrompt = null;
        });

        // Hide button if app is already installed
        window.addEventListener('appinstalled', () => {
            installContainer.style.display = 'none';
            deferredPrompt = null;
        });

        // iOS Safari detection - show install instructions
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

        if (isIOS && !isStandalone) {
            // For iOS, show the button with different behavior
            installContainer.style.display = 'block';
            installButton.onclick = () => {
                alert('Para instalar en iOS: \n1. Toca el botón "Compartir" \n2. Selecciona "Agregar a pantalla de inicio"');
            };
        }

        // Hide button if already in standalone mode
        if (isStandalone) {
            installContainer.style.display = 'none';
        }
    </script>
</body>

</html>