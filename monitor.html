<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O2 y Energía - CERMAQ STA JUANA</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Monitor en tiempo real de sistemas de oxígeno y energía">
    <meta name="theme-color" content="#60a5fa">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Monitor F1">
    <link rel="manifest" href="./monitor-manifest.json">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <link rel="stylesheet" href="style.css?v=8">
    <style>
        /* Specific Layout Overrides only */
        #mainContainer {
            flex-grow: 1;
            padding: 1.5rem 0;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }
    </style>

</head>

<body>

    <div id="refreshTimer"></div>

    <header class="glass-header d-flex justify-content-between align-items-center px-3">
        <div class="d-flex align-items-center justify-content-center w-100 position-relative">
            <div class="d-flex align-items-center gap-3">
                <img src="Cermaq_logo2.png" alt="Cermaq" height="32" class="d-inline-block align-text-top filter-white">
                <div class="border-start border-secondary ps-3 ms-2">
                    <h1 class="h6 m-0 fw-bold text-gradient text-uppercase" style="letter-spacing: 2px;">O2 Y ENERGÍA -
                        CERMAQ STA JUANA</h1>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2" style="position: absolute; right: 0;">
                <div
                    class="d-flex align-items-center gap-2 px-2 py-1 border border-success border-opacity-25 bg-success bg-opacity-10 rounded-pill me-2">
                    <div class="status-dot"></div>
                    <span id="statusText" class="small text-success fw-bold" style="font-size: 0.7rem;">ONLINE</span>
                </div>

                <button id="btnThemeToggle"
                    class="btn btn-outline-light btn-sm rounded-circle d-flex align-items-center justify-content-center border-opacity-25"
                    style="width: 40px; height: 40px;" title="Cambiar Tema">
                    <i class="bi bi-brightness-high-fill" style="font-size: 1.2rem;"></i>
                </button>
                <a href="https://docs.google.com/spreadsheets/d/1hciA4lp6se_GZFqG2XZgCxH11tKg2n63Sk39S4xP-5E/edit?usp=sharing"
                    target="_blank"
                    class="btn btn-outline-light btn-sm rounded-circle d-flex align-items-center justify-content-center border-opacity-25"
                    style="width: 40px; height: 40px;" title="Ver Hoja de Cálculo">
                    <i class="bi bi-file-earmark-spreadsheet" style="font-size: 1.2rem;"></i>
                </a>
                <a href="index.html"
                    class="btn btn-outline-light btn-sm rounded-circle d-flex align-items-center justify-content-center border-opacity-25"
                    style="width: 40px; height: 40px;" title="Ir al Ingreso">
                    <i class="bi bi-pencil-square" style="font-size: 1.2rem;"></i>
                </a>
            </div>
        </div>
    </header>

    <div id="initial-loader"
        style="position: fixed; inset: 0; background: #0a192f; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.1s ease;">
        <img src="Cermaq_logo2.png" alt="Cermaq" height="60" class="mb-4 filter-white" style="opacity: 0.8;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3 text-white-50 small" style="font-family: 'Outfit', sans-serif; letter-spacing: 2px;">CARGANDO
            SISTEMA...</div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="container-fluid px-4" id="mainContainer">
        <!-- Status Dashboard -->
        <div class="status-dashboard fade-in-down" style="animation-delay: 0.1s; margin-bottom: 1.5rem;">
            <div class="d-flex align-items-center gap-4 w-100 justify-content-center flex-wrap">
                <!-- Last Update -->
                <div class="d-flex align-items-center gap-2">
                    <div class="bg-primary bg-opacity-10 p-2 rounded-circle text-primary">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="d-flex flex-column">
                        <span class="text-white-50 small text-uppercase fw-bold"
                            style="font-size: 0.7rem; letter-spacing: 1px;">Última Actualización</span>
                        <span id="lastUpdate" class="fw-bold fs-5 text-white">--/--/---- --:--</span>
                    </div>
                </div>

                <!-- Separator -->
                <div class="d-none d-md-block border-end border-secondary opacity-25" style="height: 30px;"></div>

                <!-- Responsable -->
                <div class="d-flex align-items-center gap-2">
                    <div class="bg-success bg-opacity-10 p-2 rounded-circle text-success">
                        <i class="bi bi-person-check-fill"></i>
                    </div>
                    <div class="d-flex flex-column">
                        <span class="text-white-50 small text-uppercase fw-bold"
                            style="font-size: 0.7rem; letter-spacing: 1px;">Responsable</span>
                        <span id="lastResponsable" class="fw-bold fs-5 text-white">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid injected here -->
        <!-- loadingSpinner removed as we have full screen loader now -->
        <div id="gridContainer"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzCVzAxRBbXzJP1LQFOodK-UZ7bGMqG5h4xdHYMvVDTNLiVLf2jbMf9azAiLMlXq0yrMw/exec";
        const REFRESH_INTERVAL = 30000;
        let isFirstLoad = true;

        async function fetchData() {
            // Top Bar Logic (only for updates, not initial load)
            const timerEl = document.getElementById('refreshTimer');
            if (timerEl && !isFirstLoad) {
                timerEl.style.width = '0%';
                timerEl.style.opacity = '1';
                timerEl.style.transition = 'width 2s ease-in-out';
                setTimeout(() => timerEl.style.width = '90%', 50);
            }

            const btn = document.getElementById('btnRefresh');
            let icon = null;

            if (btn) {
                icon = btn.querySelector('i');
                btn.disabled = true;
                if (icon) icon.classList.add('spin-anim');
            }

            try {
                const response = await fetch(API_URL + "?action=latest");
                const result = await response.json();

                // Update Connectivity Status
                updateConnectionStatus(true);

                if (result.error) return;
                renderDashboard(result);

                // Remove Initial Loader with Fade Out
                const loader = document.getElementById('initial-loader');
                if (loader && isFirstLoad) {
                    // Ensure fonts are loaded before revealing
                    document.fonts.ready.then(() => {
                        loader.style.opacity = '0';
                        setTimeout(() => loader.remove(), 500);
                        isFirstLoad = false;
                    });
                }

            } catch (error) {
                console.error(error);
                updateConnectionStatus(false);
            } finally {
                // Complete Loading Bar (Top)
                if (timerEl && !isFirstLoad) {
                    timerEl.style.width = '100%';
                    setTimeout(() => {
                        timerEl.style.opacity = '0';
                        setTimeout(() => {
                            timerEl.style.transition = 'none';
                            timerEl.style.width = '0%';
                        }, 300);
                    }, 500);
                }

                if (btn) {
                    btn.disabled = false;
                    if (icon) icon.classList.remove('spin-anim');
                }
            }
        }

        function updateConnectionStatus(isOnline) {
            const statusText = document.getElementById('statusText');
            const statusDot = document.querySelector('.status-dot');
            const container = statusText.parentElement;

            if (isOnline) {
                statusText.textContent = 'ONLINE';
                statusText.className = 'small text-success fw-bold';
                if (statusDot) statusDot.style.backgroundColor = 'var(--success)';
                if (container) {
                    container.className = 'd-flex align-items-center gap-2 px-2 py-1 border border-success border-opacity-25 bg-success bg-opacity-10 rounded-pill';
                }
            } else {
                statusText.textContent = 'OFFLINE';
                statusText.className = 'small text-danger fw-bold';
                if (statusDot) statusDot.style.backgroundColor = 'var(--danger)';
                if (container) {
                    container.className = 'd-flex align-items-center gap-2 px-2 py-1 border border-danger border-opacity-25 bg-danger bg-opacity-10 rounded-pill';
                }
            }
        }

        // Network Listeners
        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));

        function renderDashboard(data) {
            // Remove spinner if present
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'none';

            const lastUpdateEl = document.getElementById('lastUpdate');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = data.timestamp || '--/--/---- --:--';
            }

            const lastResponsableEl = document.getElementById('lastResponsable');
            if (lastResponsableEl) {
                lastResponsableEl.textContent = data.responsable || '--';
            }

            // Create grid container if it doesn't exist (to preserve the header)
            let gridContainer = document.getElementById('gridContainer');
            if (!gridContainer) {
                gridContainer = document.createElement('div');
                gridContainer.id = 'gridContainer';
                document.getElementById('mainContainer').appendChild(gridContainer);
            }
            const raw = data.data || [];
            const findVal = (key) => {
                const item = raw.find(r => r[0].includes(key));
                return item ? item[1] : '-';
            };

            const groups = [
                {
                    title: "SISTEMA OXÍGENO",
                    icon: "bi-wind",
                    sections: [
                        { title: "Compresor", items: [{ l: "Flujo", v: findVal("O2 Comp M3"), u: "m³" }, { l: "KW", v: findVal("O2 Comp KW"), u: "KWh" }, { l: "Hrs", v: findVal("O2 Comp HRS"), u: "Hrs" }] },
                        { title: "Gen. O2 1", items: [{ l: "Flujo", v: findVal("O2 Gen1 M3"), u: "m³" }, { l: "Hrs", v: findVal("O2 Gen1 HRS"), u: "Hrs" }] },
                        { title: "Gen. O2 2", items: [{ l: "Flujo", v: findVal("O2 Gen2 M3"), u: "m³" }, { l: "Hrs", v: findVal("O2 Gen2 HRS"), u: "Hrs" }] }
                    ]
                },
                {
                    title: "CONSUMO O2",
                    icon: "bi-graph-down",
                    sections: [
                        { title: "Criogenico", items: [{ l: "O1 Fry", v: findVal("O2 Cons Fry"), u: "Kg" }, { l: "O2 Smolt", v: findVal("O2 Cons Smolt"), u: "Kg" }] }
                    ]
                },
                {
                    title: "RED ELÉCTRICA",
                    icon: "bi-lightning-charge",
                    sections: [
                        { title: "Voltajes", items: [{ l: "V12", v: findVal("Red V12"), u: "V" }, { l: "V23", v: findVal("Red V23"), u: "V" }, { l: "V31", v: findVal("Red V31"), u: "V" }] },
                        { title: "Corrientes", items: [{ l: "A1", v: findVal("Red I1"), u: "A" }, { l: "A2", v: findVal("Red I2"), u: "A" }, { l: "A3", v: findVal("Red I3"), u: "A" }] },
                        { title: "Potencia", items: [{ l: "Total", v: findVal("Red SumP KW"), u: "KW" }, { l: "EA+", v: findVal("Red EA GW"), u: "GW" }] }
                    ]
                },
                {
                    title: "GENERADORES",
                    icon: "bi-fuel-pump",
                    sections: [
                        { title: "Diesel 1", items: [{ l: "Hrs", v: findVal("D Gen1 HRS"), u: "Hrs" }, { l: "KW", v: findVal("D Gen1 KW"), u: "KW" }] },
                        { title: "Diesel 2", items: [{ l: "Hrs", v: findVal("D Gen2 HRS"), u: "Hrs" }, { l: "KW", v: findVal("D Gen2 KW"), u: "KW" }] },
                        { title: "Diesel 3", items: [{ l: "Hrs", v: findVal("D Gen3 HRS"), u: "Hrs" }, { l: "KW", v: findVal("D Gen3 KW"), u: "KW" }] }
                    ]
                }
            ];

            let html = '<div class="dashboard-grid">';

            groups.forEach(group => {
                html += `
                <div class="dashboard-col">
                    <div class="group-card">
                        <div class="group-header">
                             <i class="bi ${group.icon} me-2"></i> ${group.title}
                        </div>
                        <div class="group-body">`;

                group.sections.forEach(sec => {
                    html += `<div class="sub-section">
                        <div class="sub-title">${sec.title}</div>
                        <div class="data-grid">`; // Changed from row to data-grid

                    sec.items.forEach(item => {
                        html += `
                            <div class="data-item">
                                <div class="val-text">${item.v}</div>
                                <div class="label-text">${item.l}</div>
                                <div class="unit-text">${item.u}</div>
                            </div>`;
                    });

                    html += `</div></div>`;
                });

                html += `</div></div></div>`;
            });

            html += '</div>';
            gridContainer.innerHTML = html;
        }

        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL);

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const removeInitialLoader = () => {
                    document.fonts.ready.then(() => {
                        const loader = document.getElementById('initial-loader');
                        if (loader) {
                            loader.style.opacity = '0';
                            setTimeout(() => loader.remove(), 200);
                        }
                    });
                };

                const registerSW = () => {
                    navigator.serviceWorker.register('./monitor-sw.js')
                        .then(reg => {
                            console.log('Service Worker registered');
                            // Smart Switch: If update pending, keep loader
                            if (reg.waiting || reg.installing) {
                                console.log('Update pending, keeping loader...');
                                // Backup timeout
                                setTimeout(removeInitialLoader, 4000);
                            } else {
                                removeInitialLoader();
                            }
                        })
                        .catch(err => {
                            console.log('Service Worker registration failed:', err);
                            removeInitialLoader();
                        });
                };

                if (navigator.serviceWorker.controller) {
                    registerSW();
                } else {
                    // First load or no SW active yet
                    registerSW();
                }
            });
        }
    </script>
    <!-- PWA Install Button (Hidden by default) -->
    <div id="installButton" class="position-fixed bottom-0 end-0 m-4 p-3 glass-card"
        style="display: none; cursor: pointer; z-index: 9999;">
        <div class="d-flex align-items-center gap-2">
            <img src="./Q.png" width="32" height="32" class="rounded">
            <div>
                <h6 class="m-0 install-title" style="font-size: 0.9rem;">Instalar App</h6>
                <small class="install-subtitle" style="font-size: 0.75rem;">Acceso rápido</small>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script src="theme-pwa.js"></script>
</body>

</html>